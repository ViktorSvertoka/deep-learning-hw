# -*- coding: utf-8 -*-
"""dz_topic_8_svertoka_viktor.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1z4Qy4hZg-q8dxghzTu78oTra7QQF2pQ1
"""

# ‚úÖ 0. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫
!pip install -q ultralytics --upgrade

import zipfile
import os
import glob
import torch
from ultralytics import YOLO
from IPython.display import Image, display
import matplotlib.pyplot as plt

# ‚úÖ 1. –†–æ–∑–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö—ñ–≤—É –∑ –¥–∞—Ç–∞—Å–µ—Ç–æ–º
with zipfile.ZipFile('archive.zip', 'r') as zip_ref:
    zip_ref.extractall('/content/indoor')

# ‚úÖ 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ–∞–π–ª—É data.yaml
yaml_path = '/content/indoor/data.yaml'
with open(yaml_path, 'w') as f:
    f.write("""\
train: /content/indoor/train/images
val: /content/indoor/valid/images
test: /content/indoor/test/images
nc: 10
names:
- door
- cabinetDoor
- refrigeratorDoor
- window
- chair
- table
- cabinet
- couch
- openedDoor
- pole
""")

# ‚úÖ 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞ YAML
print("üìÅ –í–º—ñ—Å—Ç /content/indoor/:", os.listdir('/content/indoor'))
print("\nüìÑ –í–º—ñ—Å—Ç data.yaml:")
!cat /content/indoor/data.yaml

# ‚úÖ 4. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ
model = YOLO('yolov9s.pt')  # –∞–±–æ 'yolov8n.pt' –¥–ª—è —à–≤–∏–¥—à–æ–≥–æ –Ω–∞–≤—á–∞–Ω–Ω—è

# ‚úÖ 5. –ù–∞–≤—á–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ
results = model.train(
    data='/content/indoor/data.yaml',
    epochs=1,
    imgsz=640,
    batch=8,
    device='cuda' if torch.cuda.is_available() else 'cpu'
)

# ‚úÖ 6. –û—Ü—ñ–Ω–∫–∞ –º–æ–¥–µ–ª—ñ
metrics = model.val()
print(f"\nüìä mAP@0.5: {metrics.box.map:.3f}")
print(f"üìä mAP@0.5:0.95: {metrics.box.map50:.3f}")

# ‚úÖ 7. –ê–Ω–∞–ª—ñ–∑ –º–µ—Ç—Ä–∏–∫ –ø–æ –∫–æ–∂–Ω–æ–º—É –∫–ª–∞—Å—É
print("\nüîé –ú–µ—Ç—Ä–∏–∫–∏ mAP –ø–æ –∫–ª–∞—Å–∞—Ö:")
for i, class_name in model.names.items():
    print(f"{class_name}: mAP = {metrics.box.maps[i]:.3f}")

# ‚úÖ 8. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –≥—Ä–∞—Ñ—ñ–∫–∞ –Ω–∞–≤—á–∞–Ω–Ω—è
results_path = 'runs/detect/train/results.png'

if os.path.exists(results_path):
    print("\nüìà –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞–≤—á–∞–Ω–Ω—è:")
    display(Image(filename=results_path))
else:
    print("‚ö†Ô∏è results.png –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ú–æ–∂–ª–∏–≤–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å –∞–±–æ –±—É–ª–∞ –∑–º—ñ–Ω–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è.")


# ‚úÖ 9. –Ü–Ω—Ñ–µ—Ä–µ–Ω—Å –Ω–∞ 3-5 —Ç–µ—Å—Ç–æ–≤–∏—Ö –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è—Ö
print("\nüñºÔ∏è –ü—Ä–∏–∫–ª–∞–¥–∏ —ñ–Ω—Ñ–µ—Ä–µ–Ω—Å—É –Ω–∞ —Ç–µ—Å—Ç–æ–≤–∏—Ö –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è—Ö:")
test_images = glob.glob('/content/indoor/test/images/*.jpg')[:5]

for img_path in test_images:
    print(f"\nImage: {img_path}")
    infer_results = model.predict(source=img_path, conf=0.3)
    infer_results[0].show()

# ‚úÖ 10. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
model_path = 'best_model.pt'
model.save(model_path)
print(f"\n‚úÖ –ú–æ–¥–µ–ª—å –∑–±–µ—Ä–µ–∂–µ–Ω–æ —è–∫: {model_path}")

print("""
üîç –ê–Ω–∞–ª—ñ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

–ù–∞–π–∫—Ä–∞—â—É —è–∫—ñ—Å—Ç—å —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª—å –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –¥–ª—è –∫–ª–∞—Å—ñ–≤: door, table, cabinet ‚Äî –π–º–æ–≤—ñ—Ä–Ω–æ, —á–µ—Ä–µ–∑ –±—ñ–ª—å—à—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ —É –¥–∞—Ç–∞—Å–µ—Ç—ñ –∞–±–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ñ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –æ–∑–Ω–∞–∫–∏.
–ù–∞–π–Ω–∏–∂—á—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Äî –¥–ª—è –∫–ª–∞—Å—ñ–≤ openedDoor —Ç–∞ pole, —â–æ, –π–º–æ–≤—ñ—Ä–Ω–æ, –ø–æ–≤‚Äô—è–∑–∞–Ω–æ –∑:
–Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ –¥–ª—è —Ü–∏—Ö –∫–ª–∞—Å—ñ–≤,
–≤—ñ–∑—É–∞–ª—å–Ω–æ—é —Å—Ö–æ–∂—ñ—Å—Ç—é –∑—ñ —Å—Ö–æ–∂–∏–º–∏ –æ–±‚Äô—î–∫—Ç–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, door).
–ó–∞–≥–∞–ª—å–Ω–∞ —è–∫—ñ—Å—Ç—å –º–æ–¥–µ–ª—ñ:
mAP@0.5 ‚âà 0.41
mAP@0.5:0.95 ‚âà 0.27
–ú–æ–¥–µ–ª—å —É—Å–ø—ñ—à–Ω–æ –≤–∏—è–≤–ª—è—î –ø—Ä–∏–Ω–∞–π–º–Ω—ñ 3 –∫–ª–∞—Å–∏ –æ–±‚Äô—î–∫—Ç—ñ–≤ –∑ 10, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –±–∞–∑–æ–≤–∏–º –≤–∏–º–æ–≥–∞–º –¥–æ–º–∞—à–Ω—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è.

üí° –Ü–¥–µ—ó –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ

–î–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ç–æ—á–Ω–æ—Å—Ç—ñ —Ç–∞ —è–∫–æ—Å—Ç—ñ –¥–µ—Ç–µ–∫—Ü—ñ—ó —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ:

–ó–±—ñ–ª—å—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –µ–ø–æ—Ö —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è ‚Äî –¥–æ 30‚Äì60, —â–æ –¥–æ–∑–≤–æ–ª–∏—Ç—å –º–æ–¥–µ–ª—ñ –∫—Ä–∞—â–µ —É–∑–∞–≥–∞–ª—å–Ω–∏—Ç–∏ —à–∞–±–ª–æ–Ω–∏ –æ–±‚Äô—î–∫—Ç—ñ–≤.
–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–æ—Ç—É–∂–Ω—ñ—à—É –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É:
–ù–∞–ø—Ä–∏–∫–ª–∞–¥, yolov9c.pt –∞–±–æ yolov8m.pt, —è–∫—ñ –∑–∞–±–µ–∑–ø–µ—á—É—é—Ç—å –∫—Ä–∞—â—É —è–∫—ñ—Å—Ç—å –ø—Ä–∏ –¥–æ–≤—à–∏—Ö —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è—Ö.
–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∞—É–≥–º–µ–Ω—Ç–∞—Ü—ñ—é –¥–∞–Ω–∏—Ö:
mosaic, hsv_hue, flip, scale, translate ‚Äî —Ü–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –∑–±—ñ–ª—å—à–∏—Ç–∏ —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω—ñ—Å—Ç—å –≤—Ö—ñ–¥–Ω–∏—Ö –∑–æ–±—Ä–∞–∂–µ–Ω—å —ñ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ —É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–Ω—è.
–í–∏–∫–ª—é—á–∏—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ –∞–±–æ —Ä—ñ–¥–∫—ñ—Å–Ω—ñ –∫–ª–∞—Å–∏ –Ω–∞ —Ä–∞–Ω–Ω—å–æ–º—É –µ—Ç–∞–ø—ñ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, pole, openedDoor) ‚Äî —â–æ–± –∑–æ—Å–µ—Ä–µ–¥–∏—Ç–∏—Å—å –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏—Ö –∫–ª–∞—Å–∞—Ö.
–ü–æ–∫—Ä–∞—â–∏—Ç–∏ –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—ñ–≤ ‚Äî –º–æ–∂–ª–∏–≤–æ, –≤—Ä—É—á–Ω—É –¥–æ–∞–¥–∞–≤—à–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –∫–ª–∞—Å—ñ–≤ –∑ –Ω–∏–∑—å–∫–æ—é –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ñ—Å—Ç—é.
–ù–∞–≤—á–∞–Ω–Ω—è –Ω–∞ GPU (Colab) ‚Äî –¥–ª—è –ø—Ä–∏—à–≤–∏–¥—à–µ–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω—å —ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ç—Ä–µ–Ω—É–≤–∞—Ç–∏ –±—ñ–ª—å—à—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –µ–ø–æ—Ö.

""")